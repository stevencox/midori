###########################################################
##
## Midori System
##
##   A network simulation SDK.
##
##   onos: software defined networking operating system.
##
##   containernet: network simulation system.
##
##   redis: message cache and data store.
##
##   redisinsight: redis gui.
##
##
###########################################################
version: '3.3'

services:

  # The control plane providing an openflow controller,
  # an REST API supporting devices, links, paths, intents, etc,
  # and GUI. We specify onos apps to launch on startup.
  onos:
    image: onosproject/onos:latest
    environment:
      - ONOS_APPS=drivers,openflow,proxyarp,gui2
    restart: always
    ports:
      - 8181:8181 # GUI
      - 6633:6633 # Openflow - Mininet interface
      - 6653:6653 # Openflow - Mininet interface
    container_name: onos

  # Midori, an API and compiler for Containernet. Containernet
  # is a Mininet fork which provides container based
  # network simulation via a Python API.
  midori:
    image: midori/midori:latest
    entrypoint: /midori/bin/midorictl start
    ports:
      - 8000:8000
    volumes:
      # The docker socket is shared to allow Docker-in-Docker.
      - "/var/run/docker.sock:/var/run/docker.sock"
      - $PWD:/midori
    depends_on:
      - onos
    privileged: true
    pid: host
    tty: true
    container_name: midori

  # Redis cache and message queue for communication
  # between Midori API and Containernet execution layer.
  redis:
    image: redislabs/redisgraph:2.8.9
    restart: always
    ports:
      - 6379:6379
    container_name: redis

  # Redis admin user interface.
  redisinsight:
    image: redislabs/redisinsight:latest
    ports:
      - 8001:8001
    volumes:
      - ${PWD}:/db
